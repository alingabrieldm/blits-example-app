var ce=Object.defineProperty;var ue=(r,s,e)=>s in r?ce(r,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[s]=e;var a=(r,s,e)=>(ue(r,typeof s!="symbol"?s+"":s,e),e);const N={currentView:Symbol("currentView"),computedKeys:Symbol("computedKeys"),destroy:Symbol("destroy"),index:Symbol("index"),init:Symbol("init"),inputEvents:Symbol("inputEvents"),intervals:Symbol("intervals"),_intervals:Symbol("_intervals"),level:Symbol("level"),methodKeys:Symbol("methodKeys"),originalState:Symbol("originalState"),propKeys:Symbol("propKeys"),ready:Symbol("ready"),renderer:Symbol("renderer"),routes:Symbol("routes"),settings:Symbol("settings"),state:Symbol("state"),stateKeys:Symbol("stateKeys"),textnode:Symbol("textnode"),timeouts:Symbol("timeouts"),_timeouts:Symbol("_timeouts"),type:Symbol("type"),watchers:Symbol("watchers"),watchKeys:Symbol("watchKeys"),children:Symbol.for("children"),components:Symbol.for("components"),id:Symbol.for("id"),isSlot:Symbol.for("isSlot"),props:Symbol.for("props"),slots:Symbol.for("slots")};function he(r){const s={alpha:!0,antialias:!1,depth:!1,stencil:!0,desynchronized:!1,failIfMajorPerformanceCaveat:!0,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!1};return r.getContext("webgl",s)||r.getContext("experimental-webgl",s)}function y(r,s){if(!r)throw new Error(s||"Assertion failed")}function Ce(r,s,e){const t=Math.trunc(r>>>24),n=Math.trunc(r>>>16&255),i=Math.trunc(r>>>8&255),o=Math.trunc(r&255),h=Math.trunc(s>>>24),c=Math.trunc(s>>>16&255),l=Math.trunc(s>>>8&255),T=Math.trunc(s&255),f=Math.round(h*e+t*(1-e)),m=Math.round(c*e+n*(1-e)),_=Math.round(l*e+i*(1-e)),x=Math.round(T*e+o*(1-e));return(f<<24|m<<16|_<<8|x)>>>0}function Be(r,s){const e=r>>>24,t=r>>>16&255,n=r>>>8&255,i=Math.trunc((r&255)*s);return(e<<24|t<<16|n<<8|i)>>>0}function w(r,s,e=!1){const t=(r&255)/255*s,n=Math.trunc((r>>>24)*t),i=Math.trunc((r>>>16&255)*t),o=Math.trunc((r>>>8&255)*t),h=Math.trunc(t*255);return e?(h<<24|o<<16|i<<8|n)>>>0:(n<<24|i<<16|o<<8|h)>>>0}function W(r,s){return Object.prototype.hasOwnProperty.call(r,s)}const Q=r=>r&&!(r&r-1),g=(r,s,e,t)=>{const n=3*r,i=3*(e-r)-n,o=1-n-i,h=3*s,c=3*(t-s)-h,l=1-h-c;return function(T){if(T>=1)return 1;if(T<=0)return 0;let f=.5,m,_,x;for(let p=0;p<20;p++){if(m=f*(f*(f*o+i)+n),x=T-m,x>-1e-8&&x<1e-8)return f*(f*(f*l+c)+h);if(_=f*(f*(3*o)+2*i)+n,_>1e-10&&_<1e-10)break;f+=x/_}let d=0,E=1;for(let p=0;p<20;p++){if(f=.5*(d+E),m=f*(f*(f*o+i)+n),x=T-m,x>-1e-8&&x<1e-8)return f*(f*(f*l+c)+h);x<0?E=f:d=f}}},Le=r=>{switch(r){case"linear":return function(e){return e};case"ease":return g(.25,.1,.25,1);case"ease-in":return g(.42,0,1,1);case"ease-out":return g(0,0,.58,1);case"ease-in-out":return g(.42,0,.58,1);case"ease-in-sine":return g(.12,0,.39,0);case"ease-out-sine":return g(.12,0,.39,0);case"ease-in-out-sine":return g(.37,0,.63,1);case"ease-in-cubic":return g(.32,0,.67,0);case"ease-out-cubic":return g(.33,1,.68,1);case"ease-in-out-cubic":return g(.65,0,.35,1);case"ease-in-circ":return g(.55,0,1,.45);case"ease-out-circ":return g(0,.55,.45,1);case"ease-in-out-circ":return g(.85,0,.15,1);case"ease-in-back":return g(.36,0,.66,-.56);case"ease-out-back":return g(.34,1.56,.64,1);case"ease-in-out-back":return g(.68,-.6,.32,1.6);case"step-start":return function(){return 1};case"step-end":return function(e){return e===1?1:0};default:const s="cubic-bezier(";if(r&&r.indexOf(s)===0){const e=r.substr(s.length,r.length-s.length-1).split(",");if(e.length!==4)return console.warn("Unknown timing function: "+r),function(h){return h};const t=parseFloat(e[0]||"0.42"),n=parseFloat(e[1]||"0"),i=parseFloat(e[2]||"1"),o=parseFloat(e[3]||"1");return isNaN(t)||isNaN(n)||isNaN(i)||isNaN(o)?(console.warn(" Unknown timing function: "+r),function(h){return h}):g(t,n,i,o)}else return console.warn("Unknown timing function: "+r),function(e){return e}}};Math.hypot||(Math.hypot=(...r)=>{let s=0,e=r.length;for(;e--;)s+=r[e]*r[e];return Math.sqrt(s)});class ee{constructor(){a(this,"eventListeners",{})}on(s,e){let t=this.eventListeners[s];t||(t=[]),t.push(e),this.eventListeners[s]=t}off(s,e){const t=this.eventListeners[s];if(!t)return;if(!e){delete this.eventListeners[s];return}const n=t.indexOf(e);n>=0&&t.splice(n,1)}once(s,e){const t=(n,i)=>{this.off(s,t),e(n,i)};this.on(s,t)}emit(s,e){const t=this.eventListeners[s];t&&[...t].forEach(n=>{n(this,e)})}removeAllListeners(){this.eventListeners={}}}class fe{constructor(s){a(this,"textureSource");this.textureSource=s}}class le{constructor(s){a(this,"stage");this.stage=s}}class de{}class xe{static makeCacheKey(s){return!1}static resolveDefaults(s){return{}}}function j(r,s,e){const t=r.createShader(s);if(!t)throw new Error;if(r.shaderSource(t,e),r.compileShader(t),r.getShaderParameter(t,r.COMPILE_STATUS))return t;console.log(r.getShaderInfoLog(t)),r.deleteShader(t)}function Te(r,s,e){const t=r.createProgram();if(!t)throw new Error;if(r.attachShader(t,s),r.attachShader(t,e),r.linkProgram(t),r.getProgramParameter(t,r.LINK_STATUS))return t;console.log(r.getProgramInfoLog(t)),r.deleteProgram(t)}function H(r){return self.WebGL2RenderingContext&&r instanceof self.WebGL2RenderingContext}class $ extends xe{constructor(e){super();a(this,"boundBufferCollection",null);a(this,"buffersBound",!1);a(this,"program");a(this,"vao");a(this,"renderer");a(this,"gl");a(this,"attributeBuffers");a(this,"attributeLocations");a(this,"attributeNames");a(this,"uniformLocations");a(this,"uniformTypes");a(this,"supportsIndexedTextures");const t=this.renderer=e.renderer,n=this.gl=this.renderer.gl;this.supportsIndexedTextures=e.supportsIndexedTextures||!1;const i=H(n),o=i&&e.webgl2Extensions||!i&&e.webgl1Extensions||[],h=i?"2.0":"1.0";o.forEach(d=>{if(!n.getExtension(d))throw new Error(`Shader "${this.constructor.name}" requires extension "${d}" for WebGL ${h} but wasn't found`)});const c=e.shaderSources||this.constructor.shaderSources;if(c)i&&(c!=null&&c.webGl2)&&(c.fragment=c.webGl2.fragment,c.vertex=c.webGl2.vertex,delete c.webGl2);else throw new Error(`Shader "${this.constructor.name}" is missing shaderSources.`);const l=t.system.parameters.MAX_VERTEX_TEXTURE_IMAGE_UNITS,T=c.vertex instanceof Function?c.vertex(l):c.vertex,f=c.fragment instanceof Function?c.fragment(l):c.fragment,m=j(n,n.VERTEX_SHADER,T),_=j(n,n.FRAGMENT_SHADER,f);if(!m||!_)throw new Error;const x=Te(n,m,_);if(!x)throw new Error;if(this.program=x,i){const d=n.createVertexArray();if(!d)throw new Error;this.vao=d,n.bindVertexArray(this.vao)}this.attributeLocations={},this.attributeBuffers={},this.attributeNames=[],[...e.attributes].forEach(d=>{const E=n.getAttribLocation(this.program,d);if(E<0)throw new Error(`${this.constructor.name}: Vertex shader must have an attribute "${d}"!`);const p=n.createBuffer();if(!p)throw new Error(`${this.constructor.name}: Could not create buffer for attribute "${d}"`);this.attributeLocations[d]=E,this.attributeBuffers[d]=p,this.attributeNames.push(d)}),this.uniformLocations={},this.uniformTypes={},e.uniforms.forEach(d=>{const E=n.getUniformLocation(this.program,d.name);if(this.uniformTypes[d.name]=d.uniform,!E){console.warn(`Shader "${this.constructor.name}" could not get uniform location for "${d.name}"`);return}this.uniformLocations[d.name]=E})}bindBufferAttribute(e,t,n){const i=this.gl;i.enableVertexAttribArray(e),i.bindBuffer(i.ARRAY_BUFFER,t),i.vertexAttribPointer(e,n.size,n.type,n.normalized,n.stride,n.offset)}disableAttribute(e){this.gl.disableVertexAttribArray(e)}disableAttributes(){for(const e in this.attributeLocations)this.disableAttribute(this.attributeLocations[e]);this.boundBufferCollection=null}canBatchShaderProps(e,t){return!1}bindRenderOp(e,t){this.bindBufferCollection(e.buffers),e.textures.length>0&&this.bindTextures(e.textures);const{gl:n}=e;if(this.setUniform("u_resolution",[n.canvas.width,n.canvas.height]),this.setUniform("u_pixelRatio",e.options.pixelRatio),t){if(W(t,"$dimensions")){let i=t.$dimensions;i||(i=e.dimensions),this.setUniform("u_dimensions",[i.width,i.height])}if(W(t,"$alpha")){let i=t.$alpha;i||(i=e.alpha),this.setUniform("u_alpha",i)}this.bindProps(t)}}setUniform(e,...t){this.gl[this.uniformTypes[e]](this.uniformLocations[e],...t)}bindBufferCollection(e){if(this.boundBufferCollection!==e){for(const t in this.attributeLocations){const n=e.getBuffer(t),i=e.getAttributeInfo(t);y(n,`Buffer for "${t}" not found`),y(i),this.bindBufferAttribute(this.attributeLocations[t],n,i)}this.boundBufferCollection=e}}bindProps(e){}bindTextures(e){}attach(){this.gl.useProgram(this.program),H(this.gl)&&this.vao&&this.gl.bindVertexArray(this.vao)}detach(){this.disableAttributes()}}a($,"shaderSources");class Z extends de{constructor(e,t,n,i,o,h,c,l,T,f){super();a(this,"gl");a(this,"options");a(this,"buffers");a(this,"shader");a(this,"shaderProps");a(this,"alpha");a(this,"clippingRect");a(this,"dimensions");a(this,"bufferIdx");a(this,"zIndex");a(this,"length",0);a(this,"numQuads",0);a(this,"textures",[]);a(this,"maxTextures");this.gl=e,this.options=t,this.buffers=n,this.shader=i,this.shaderProps=o,this.alpha=h,this.clippingRect=c,this.dimensions=l,this.bufferIdx=T,this.zIndex=f,this.gl=e,this.maxTextures=i.supportsIndexedTextures?e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS):1}addTexture(e){const{textures:t,maxTextures:n}=this,i=t.findIndex(h=>h===e);if(i!==-1)return i;const o=t.length;return o>=n?4294967295:(this.textures.push(e),o)}draw(){const{gl:e,shader:t,shaderProps:n,options:i}=this,{shManager:o}=i;o.useShader(t),t.bindRenderOp(this,n);const h=this.bufferIdx/24*6*2;if(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),this.clippingRect){const{x:c,y:l,width:T,height:f}=this.clippingRect,m=i.pixelRatio,_=i.canvas.height,x=Math.round(c*m),d=Math.round(T*m),E=Math.round(f*m),p=Math.round(_-E-l*m);e.enable(e.SCISSOR_TEST),e.scissor(x,p,d,E)}else e.disable(e.SCISSOR_TEST);e.drawElements(e.TRIANGLES,6*this.numQuads,e.UNSIGNED_SHORT,h)}}function Ee(r){const s={MAX_RENDERBUFFER_SIZE:0,MAX_TEXTURE_SIZE:0,MAX_VIEWPORT_DIMS:0,MAX_VERTEX_TEXTURE_IMAGE_UNITS:0,MAX_TEXTURE_IMAGE_UNITS:0,MAX_COMBINED_TEXTURE_IMAGE_UNITS:0,MAX_VERTEX_ATTRIBS:0,MAX_VARYING_VECTORS:0,MAX_VERTEX_UNIFORM_VECTORS:0,MAX_FRAGMENT_UNIFORM_VECTORS:0};return Object.keys(s).forEach(t=>{s[t]=r.getParameter(r[t])}),s}function _e(r){const s={ANGLE_instanced_arrays:null,WEBGL_compressed_texture_s3tc:null,WEBGL_compressed_texture_astc:null,WEBGL_compressed_texture_etc:null,WEBGL_compressed_texture_etc1:null,WEBGL_compressed_texture_pvrtc:null,WEBKIT_WEBGL_compressed_texture_pvrtc:null,WEBGL_compressed_texture_s3tc_srgb:null,OES_vertex_array_object:null};return Object.keys(s).forEach(t=>{s[t]=r.getExtension(t)}),s}function pe(r,s){if(!r)throw new Error("No WebGL context");const e=~~(s/80),t=new Uint16Array(e*6);for(let i=0,o=0;i<e;i+=6,o+=4)t[i]=o,t[i+1]=o+1,t[i+2]=o+2,t[i+3]=o+2,t[i+4]=o+1,t[i+5]=o+3;const n=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,n),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t,r.STATIC_DRAW)}const J=new Uint8Array([0,0,0,0]);class Y extends fe{constructor(e,t){super(t);a(this,"gl");a(this,"_nativeCtxTexture",null);a(this,"_state","freed");a(this,"_w",0);a(this,"_h",0);this.gl=e}get ctxTexture(){return this._state==="freed"&&this.load(),y(this._nativeCtxTexture),this._nativeCtxTexture}get w(){return this._w}get h(){return this._h}load(){this._state==="loading"||this._state==="loaded"||(this._state="loading",this.textureSource.setState("loading"),this.onLoadRequest().then(({width:e,height:t})=>{this._state="loaded",this._w=e,this._h=t,this.textureSource.setState("loaded",{width:e,height:t})}).catch(e=>{this._state="failed",this.textureSource.setState("failed",e),console.error(e)}))}async onLoadRequest(){var o;this._nativeCtxTexture=this.createNativeCtxTexture();const{gl:e}=this;e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,J);const t=await((o=this.textureSource)==null?void 0:o.getTextureData());let n=0,i=0;if(y(this._nativeCtxTexture),t.data instanceof ImageBitmap||t.data instanceof ImageData){const h=t.data;n=h.width,i=h.height,e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!t.premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),(H(e)||Q(n)&&Q(i))&&e.generateMipmap(e.TEXTURE_2D)}else t.data===null?(n=0,i=0,e.bindTexture(e.TEXTURE_2D,this._nativeCtxTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,J)):console.error("WebGlCoreCtxTexture.onLoadRequest: Unexpected textureData returned",t);return{width:n,height:i}}free(){this._state!=="freed"&&(this._state="freed",this._w=0,this._h=0,this._nativeCtxTexture&&(this.gl.deleteTexture(this._nativeCtxTexture),this._nativeCtxTexture=null))}createNativeCtxTexture(){const e=this.gl.createTexture();if(!e)throw new Error("Could not create WebGL Texture");return e}}class k extends ee{constructor(e){super();a(this,"txManager");a(this,"dimensions",null);a(this,"error",null);a(this,"state","loading");this.txManager=e}setState(e,...t){if(this.state!==e){if(this.state=e,e==="loaded"){const n=t;this.dimensions=n[0]}else if(e==="failed"){const n=t;this.error=n[0]}this.emit(e,...t)}}static makeCacheKey(e){return!1}static resolveDefaults(e){return{}}}const L=class L extends k{constructor(e,t){super(e);a(this,"props");this.props=L.resolveDefaults(t||{})}get color(){return this.props.color}set color(e){this.props.color=e}async getTextureData(){const e=new Uint32Array([this.color]),t=new Uint8ClampedArray(e.buffer);return{data:new ImageData(t,1,1),premultiplyAlpha:!0}}static makeCacheKey(e){return`ColorTexture,${L.resolveDefaults(e).color}`}static resolveDefaults(e){return{color:e.color||4294967295}}};a(L,"z$__type__Props");let V=L;const F=class F extends k{constructor(e,t){super(e);a(this,"props");a(this,"parentTexture");a(this,"onParentTxLoaded",()=>{this.setState("loaded",{width:this.props.width,height:this.props.height})});a(this,"onParentTxFailed",(e,t)=>{this.setState("failed",t)});this.parentTexture=this.txManager.loadTexture(t.texture.txType,t.texture.props,t.texture.options),this.props=F.resolveDefaults(t||{}),queueMicrotask(()=>{const n=this.parentTexture;n.state==="loaded"?this.onParentTxLoaded(n,n.dimensions):n.state==="failed"&&this.onParentTxFailed(n,n.error),n.on("loaded",this.onParentTxLoaded),n.on("failed",this.onParentTxFailed)})}async getTextureData(){return{data:this.props}}static makeCacheKey(e){return!1}static resolveDefaults(e){return{texture:e.texture,x:e.x||0,y:e.y||0,width:e.width||0,height:e.height||0}}};a(F,"z$__type__Props");let D=F;class ge extends Y{constructor(s,e){super(s,e)}async onLoadRequest(){var e,t;const s=await this.textureSource.getTextureData();return{width:((e=s.data)==null?void 0:e.width)||0,height:((t=s.data)==null?void 0:t.height)||0}}}const me=r=>{const s=r>>>24,e=r>>>16&255,t=r>>>8&255,n=r&255;return[s/255,e/255,t/255,n/255]};function Oe(r){return(r&255)/255}function Pe(r){const s=Math.floor(r[0]*255),e=Math.floor(r[1]*255),t=Math.floor(r[2]*255),n=Math.floor(r[3]*255);return`rgba(${s},${e},${t},${n.toFixed(4)})`}function Ne(r,s){const e={x1:Math.max(r.x1,s.x1),y1:Math.max(r.y1,s.y1),x2:Math.min(r.x2,s.x2),y2:Math.min(r.y2,s.y2)};return e.x1<e.x2&&e.y1<e.y2?e:{x1:0,y1:0,x2:0,y2:0}}function De(r,s){const e=Math.max(r.x,s.x),t=Math.max(r.y,s.y),n=Math.min(r.x+r.width,s.x+s.width)-e,i=Math.min(r.y+r.height,s.y+s.height)-t;return n>0&&i>0?{x:e,y:t,width:n,height:i}:{x:0,y:0,width:0,height:0}}function Re(r,s){return r===s?!0:r===null||s===null?!1:r.x===s.x&&r.y===s.y&&r.width===s.width&&r.height===s.height}function Fe(r){return r.x1<r.x2&&r.y1<r.y2}class ye{constructor(s){a(this,"config");this.config=s}getBuffer(s){var e;return(e=this.config.find(t=>t.attributes[s]))==null?void 0:e.buffer}getAttributeInfo(s){var e;return(e=this.config.find(t=>t.attributes[s]))==null?void 0:e.attributes[s]}}const Ae=24;class Se extends le{constructor(e){super(e.stage);a(this,"gl");a(this,"system");a(this,"txManager");a(this,"shManager");a(this,"options");a(this,"quadBuffer",new ArrayBuffer(1024*1024*4));a(this,"fQuadBuffer",new Float32Array(this.quadBuffer));a(this,"uiQuadBuffer",new Uint32Array(this.quadBuffer));a(this,"renderOps",[]);a(this,"curBufferIdx",0);a(this,"curRenderOp",null);a(this,"renderables",[]);a(this,"defaultShader");a(this,"quadBufferCollection");a(this,"defaultTexture");const{canvas:t,clearColor:n,bufferMemory:i}=e;this.options=e,this.txManager=e.txManager,this.shManager=e.shManager,this.defaultTexture=new V(this.txManager);const o=he(t);if(!o)throw new Error("Unable to create WebGL context");this.gl=o;const h=me(n);o.viewport(0,0,t.width,t.height),o.clearColor(h[0],h[1],h[2],h[3]),pe(o,i),this.system={parameters:Ee(o),extensions:_e(o)},this.shManager.renderer=this,this.defaultShader=this.shManager.loadShader("DefaultShaderBatched").shader;const c=o.createBuffer();y(c);const l=6*Float32Array.BYTES_PER_ELEMENT;this.quadBufferCollection=new ye([{buffer:c,attributes:{a_position:{name:"a_position",size:2,type:o.FLOAT,normalized:!1,stride:l,offset:0},a_textureCoordinate:{name:"a_textureCoordinate",size:2,type:o.FLOAT,normalized:!1,stride:l,offset:2*Float32Array.BYTES_PER_ELEMENT},a_color:{name:"a_color",size:4,type:o.UNSIGNED_BYTE,normalized:!0,stride:l,offset:4*Float32Array.BYTES_PER_ELEMENT},a_textureIndex:{name:"a_textureIndex",size:1,type:o.FLOAT,normalized:!1,stride:l,offset:5*Float32Array.BYTES_PER_ELEMENT}}}])}reset(){this.curBufferIdx=0,this.curRenderOp=null,this.renderOps.length=0,this.gl.clear(this.gl.COLOR_BUFFER_BIT)}getShaderManager(){return this.shManager}createCtxTexture(e){return e instanceof D?new ge(this.gl,e):new Y(this.gl,e)}addRenderable(e){var t;(t=this.renderables)==null||t.push(e)}addQuad(e){const{fQuadBuffer:t,uiQuadBuffer:n}=this,{width:i,height:o,colorTl:h,colorTr:c,colorBl:l,colorBr:T,textureOptions:f,shader:m,shaderProps:_,alpha:x,clippingRect:d,tx:E,ty:p,ta:G,tb:v,tc:U,td:X}=e;let{texture:A}=e;if(_&&W(_,"$dimensions")){const B=_.$dimensions;B.width=i,B.height=o}A=A??this.defaultTexture,y(A instanceof k,"Invalid texture type");let{curBufferIdx:u,curRenderOp:R}=this;const re={width:i,height:o},O=m||this.defaultShader;y(O instanceof $),R&&(R.shader!==O||!Re(R.clippingRect,d)||R.shader!==this.defaultShader&&(!_||!R.shader.canBatchShaderProps(R.shaderProps,_)))&&(R=null),y(O instanceof $),R||(this.newRenderOp(O,_,x,re,d,u),R=this.curRenderOp,y(R));const se=(f==null?void 0:f.flipX)??!1,ne=(f==null?void 0:f.flipY)??!1;let S=0,b=0,M=1,C=1;if(A instanceof D){const{x:B,y:P,width:oe,height:ae}=A.props,{width:K=0,height:q=0}=A.parentTexture.dimensions||{width:0,height:0};S=B/K,M=S+oe/K,b=P/q,C=b+ae/q,A=A.parentTexture}se&&([S,M]=[M,S]),ne&&([b,C]=[C,b]);const{txManager:ie}=this.stage,z=ie.getCtxTexture(A);y(z instanceof Y);const I=this.addTexture(z,u);if(R=this.curRenderOp,y(R),v!==0||U!==0)t[u++]=E,t[u++]=p,t[u++]=S,t[u++]=b,n[u++]=w(h,x,!0),t[u++]=I,t[u++]=E+i*G,t[u++]=p+i*U,t[u++]=M,t[u++]=b,n[u++]=w(c,x,!0),t[u++]=I,t[u++]=E+o*v,t[u++]=p+o*X,t[u++]=S,t[u++]=C,n[u++]=w(l,x,!0),t[u++]=I,t[u++]=E+i*G+o*v,t[u++]=p+i*U+o*X,t[u++]=M,t[u++]=C,n[u++]=w(T,x,!0),t[u++]=I;else{const B=E+i*G,P=p+o*X;t[u++]=E,t[u++]=p,t[u++]=S,t[u++]=b,n[u++]=w(h,x,!0),t[u++]=I,t[u++]=B,t[u++]=p,t[u++]=M,t[u++]=b,n[u++]=w(c,x,!0),t[u++]=I,t[u++]=E,t[u++]=P,t[u++]=S,t[u++]=C,n[u++]=w(l,x,!0),t[u++]=I,t[u++]=B,t[u++]=P,t[u++]=M,t[u++]=C,n[u++]=w(T,x,!0),t[u++]=I}R.length+=Ae,R.numQuads++,this.curBufferIdx=u}newRenderOp(e,t,n,i,o,h){const c=new Z(this.gl,this.options,this.quadBufferCollection,e,t,n,o,i,h,0);this.curRenderOp=c,this.renderOps.push(c)}addTexture(e,t,n){const{curRenderOp:i}=this;y(i);const o=i.addTexture(e);if(o===4294967295){if(n)throw new Error("Unable to add texture to render op");const{shader:h,shaderProps:c,dimensions:l,clippingRect:T,alpha:f}=i;return this.newRenderOp(h,c,f,l,T,t),this.addTexture(e,t,!0)}return o}sortRenderables(){const{renderables:e}=this;e.sort((t,n)=>t.zIndex-n.zIndex),e.forEach(t=>{t instanceof Z?(this.renderOps.push(t),this.curRenderOp=null):this.addQuad(t)})}render(e="screen"){const{gl:t,quadBuffer:n}=this,i=new Float32Array(n,0,this.curBufferIdx),o=this.quadBufferCollection.getBuffer("a_position")??null;t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,i,t.DYNAMIC_DRAW),this.renderOps.forEach((h,c)=>{h.draw()}),this.renderables=[]}}class te extends ee{constructor(e,t){super();a(this,"fontFamily");a(this,"descriptors");a(this,"loaded",!1);this.fontFamily=e,this.descriptors={style:"normal",weight:"normal",stretch:"normal",...t}}static convertToCssFontFaceDescriptors(e){return{style:e.style,weight:typeof e.weight=="number"?`${e.weight}`:e.weight,stretch:e.stretch,unicodeRange:e.unicodeRange,variant:e.variant,featureSettings:e.featureSettings,display:e.display}}}const be={LINE_FEED:10,CARRIAGE_RETURN:13,SPACE:32,TAB:9,ZERO_WIDTH_SPACE:8203,ZERO_WIDTH_NON_JOINER:8204,ZERO_WIDTH_JOINER:8205,LEFT_TO_RIGHT_MARK:8206,RIGHT_TO_LEFT_MARK:8207,LEFT_TO_RIGHT_EMBEDDING:8234,RIGHT_TO_LEFT_EMBEDDING:8235,POP_DIRECTIONAL_FORMATTING:8236,LEFT_TO_RIGHT_OVERRIDE:8237,RIGHT_TO_LEFT_OVERRIDE:8238,LINE_SEPARATOR:8232,PARAGRAPH_SEPARATOR:8233,OBJECT_REPLACEMENT_CHARACTER:65532,REPLACEMENT_CHARACTER:65533,ZERO_WIDTH_NO_BREAK_SPACE:65279,LEFT_TO_RIGHT_ISOLATE:8294,RIGHT_TO_LEFT_ISOLATE:8295,FIRST_STRONG_ISOLATE:8296,POP_DIRECTIONAL_ISOLATE:8297,INHIBIT_SYMMETRIC_SWAPPING:8298,ACTIVATE_SYMMETRIC_SWAPPING:8299,INHIBIT_ARABIC_FORM_SHAPING:8300,ACTIVATE_ARABIC_FORM_SHAPING:8301,NATIONAL_DIGIT_SHAPES:8302,NOMINAL_DIGIT_SHAPES:8303,LEFT_TO_RIGHT_BOUNDARY:8206,RIGHT_TO_LEFT_BOUNDARY:8207};class Ie{}class we extends Ie{constructor(e){super();a(this,"data");a(this,"kernings");this.data=e;const t=this.kernings={};e.kernings.forEach(n=>{const i=n.second,o=t[i]=t[i]||{};o[n.first]=n.amount}),this.kernings=t}*shapeText(e,t){var o;let n,i;for(;(n=t.peek())&&!n.done;){const h=n.value,c=this.data.chars.find(l=>l.id===h);if(t.next(),c!==void 0){const l=i!==void 0?(((o=this.kernings[c.id])==null?void 0:o[i])||0)+e.letterSpacing:0;i=c.id,yield{mapped:!0,glyphId:c.id,codepoint:h,cluster:t.lastIndex,xAdvance:c.xadvance+l,yAdvance:0,xOffset:c.xoffset+l,yOffset:c.yoffset,xBearing:0,yBearing:0,width:c.width,height:c.height}}else h===be.LINE_FEED&&(i=void 0),yield{mapped:!1,codepoint:h,cluster:t.lastIndex}}}}class Ge extends te{constructor(e,t,n,i,o,h){super(e,t);a(this,"type");a(this,"texture");a(this,"data");a(this,"shaper");a(this,"glyphMap",new Map);this.type=n;const c=i.renderer;y(c instanceof Se,"SDF Font Faces can only be used with the WebGL Renderer"),this.texture=i.txManager.loadTexture("ImageTexture",{src:o,premultiplyAlpha:!1},{preload:!0}),fetch(h).then(async l=>{this.data=await l.json(),this.shaper=new we(this.data),this.data.chars.forEach(T=>{this.glyphMap.set(T.id,T)}),this.checkLoaded()}).catch(console.error)}getAtlasEntry(e){const t=this.glyphMap.get(e);if(t===void 0)throw new Error(`Glyph ${e} not found in font ${this.fontFamily}`);return{x:t.x,y:t.y,width:t.width,height:t.height}}checkLoaded(){this.loaded||this.data&&(this.loaded=!0,this.emit("loaded"))}}class ve extends te{constructor(e,t,n){super(e,t);a(this,"fontFace");a(this,"fontUrl");const i=n.replace(/\(|\)/g,""),o=this.descriptors,h={style:o.style,weight:typeof o.weight=="number"?`${o.weight}`:o.weight,stretch:o.stretch,unicodeRange:o.unicodeRange,variant:o.variant,featureSettings:o.featureSettings,display:o.display},c=new FontFace(e,`url(${i})`,h);c.load().then(()=>{this.loaded=!0,this.emit("loaded")}).catch(console.error),this.fontFace=c,this.fontUrl=n}}class Ue{}const Xe={[N.settings]:{},get(r,s=null){return r in this[N.settings]?this[N.settings][r]:s},set(r,s){typeof r=="object"?Object.keys(r).forEach(e=>{this.set(e,r[e])}):this[N.settings][r]=s}};export{ye as B,V as C,ee as E,D as S,k as T,$ as W,y as a,me as b,Ge as c,Ne as d,Z as e,Be as f,Le as g,Pe as h,Fe as i,ve as j,De as k,Oe as l,Ce as m,Se as n,Ue as o,Xe as p,N as s};
